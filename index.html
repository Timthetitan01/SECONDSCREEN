<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondScreen Pro | Stream Deck Edition</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        :root {
            /* Apple System Colors */
            --bg-body: #000000;
            --ios-card: rgba(28, 28, 30, 0.65);
            --ios-card-border: rgba(255, 255, 255, 0.12);
            --ios-input: rgba(118, 118, 128, 0.24);
            --ios-blue: #0A84FF;
            --ios-green: #30D158;
            --ios-red: #FF453A;
            --ios-orange: #FF9F0A;
            --ios-yellow: #FFD60A;
            --ios-purple: #BF5AF2;
            --ios-indigo: #5E5CE6;
            --text-main: #FFFFFF;
            --text-sec: #EBEBF599; 
            
            --blur: blur(50px) saturate(180%);
            --radius: 22px;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; user-select: none; }

        body {
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 20% 0%, rgba(94, 92, 230, 0.25) 0%, transparent 50%),
                radial-gradient(circle at 80% 100%, rgba(10, 132, 255, 0.2) 0%, transparent 50%);
            color: var(--text-main);
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Navbar */
        nav {
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--ios-card-border);
            z-index: 1000;
        }

        .brand { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .nav-actions { display: flex; gap: 10px; }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: none; color: white; padding: 6px 14px; border-radius: 99px;
            font-size: 13px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.2); }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .btn-primary { background: var(--ios-blue); }
        .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--ios-red); }

        /* Dashboard */
        #dashboard-wrapper { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; }

        .grid-stack-item-content {
            background: var(--ios-card) !important;
            backdrop-filter: var(--blur) !important;
            border: 1px solid var(--ios-card-border) !important;
            border-radius: var(--radius) !important;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* Editing State */
        .remove-widget {
            position: absolute; top: -6px; left: -6px; width: 22px; height: 22px;
            background: #8e8e93; border: 2px solid var(--bg-body); border-radius: 50%;
            color: white; display: none; justify-content: center; align-items: center;
            font-size: 10px; cursor: pointer; z-index: 1001;
        }
        .editing .remove-widget { display: flex; }
        .editing .grid-stack-item-content { animation: jiggle 0.3s infinite ease-in-out; border-color: var(--ios-blue) !important; }
        @keyframes jiggle { 0% { transform: rotate(-0.5deg); } 50% { transform: rotate(0.5deg); } 100% { transform: rotate(-0.5deg); } }

        /* Widget Headers */
        .w-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; height: 16px; flex-shrink: 0; }
        .w-label { font-size: 11px; font-weight: 600; color: var(--ios-blue); text-transform: uppercase; letter-spacing: 0.5px; }
        .w-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* --- Custom Widget Styles --- */

        /* 1. Fixed Clock */
        .clock-container { display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; }
        .time-big { font-size: 52px; font-weight: 200; letter-spacing: -1px; line-height: 1; margin-bottom: 5px; font-variant-numeric: tabular-nums; }
        .date-sub { font-size: 15px; color: var(--ios-red); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* 2. Stream Deck (Quick Links) */
        .deck-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; height: 100%; }
        .deck-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.1s;
            position: relative; overflow: hidden;
        }
        .deck-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); box-shadow: 0 0 15px var(--ios-blue); border-color: var(--ios-blue); }
        .deck-btn:hover { background: rgba(255,255,255,0.12); }
        .deck-icon { font-size: 20px; color: var(--text-main); }
        .deck-label { font-size: 10px; font-weight: 600; color: var(--text-sec); text-align: center; white-space: nowrap; overflow: hidden; width: 90%; text-overflow: ellipsis; }
        .deck-unset { color: var(--text-sec); opacity: 0.5; }

        /* 3. Days Until */
        .count-container { display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; cursor: pointer; }
        .count-days { font-size: 42px; font-weight: 700; color: var(--text-main); line-height: 1; margin-bottom: 4px; }
        .count-label { font-size: 12px; color: var(--text-sec); font-weight: 500; }
        .count-progress { height: 4px; background: rgba(255,255,255,0.1); margin-top: 10px; border-radius: 2px; overflow: hidden; width: 80%; margin-left: auto; margin-right: auto; }
        .count-fill { height: 100%; background: var(--ios-indigo); border-radius: 2px; width: 100%; }

        /* Generic Inputs */
        input, textarea, select {
            background: var(--ios-input); border: none; color: white;
            padding: 8px 12px; border-radius: 10px; width: 100%; font-size: 13px; outline: none;
        }

        /* Add Panel */
        #add-panel {
            position: fixed; bottom: -600px; left: 0; width: 100%;
            background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(40px);
            border-top: 1px solid var(--ios-card-border); padding: 30px 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 2000; border-radius: 24px 24px 0 0;
        }
        #add-panel.show { transform: translateY(-600px); }
        
        .add-card {
            background: rgba(255,255,255,0.05); padding: 15px 10px; border-radius: 18px; text-align: center; cursor: pointer;
            transition: all 0.2s; display:flex; flex-direction:column; align-items:center; gap:8px;
        }
        .add-card:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .add-label { font-size: 11px; font-weight: 500; color: var(--text-sec); }

        ::-webkit-scrollbar { width: 0px; } 
    </style>
</head>
<body>

    <nav>
        <div class="brand"><i class="fa-brands fa-apple"></i> SecondScreen Pro</div>
        <div class="nav-actions">
            <button class="btn btn-primary" onclick="UI.toggleAdd(true)"><i class="fa-solid fa-plus"></i> Add</button>
            <button id="edit-btn" class="btn" onclick="Core.toggleEdit()"><i class="fa-solid fa-pen-nib"></i> Edit</button>
            <button class="btn" onclick="Core.saveLayout()"><i class="fa-solid fa-cloud"></i></button>
            <button class="btn btn-danger" onclick="Core.reset()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div id="dashboard-wrapper">
        <div class="grid-stack"></div>
    </div>

    <div id="add-panel">
        <div class="add-card" onclick="Core.createWidget('links', 4, 2)">
            <i class="fa-solid fa-gamepad add-icon" style="color:var(--ios-blue); font-size:24px"></i><span class="add-label">Quick Links</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('countdown', 2, 2)">
            <i class="fa-solid fa-hourglass-half add-icon" style="color:var(--ios-indigo); font-size:24px"></i><span class="add-label">Days Until</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('clock', 4, 2)">
            <i class="fa-regular fa-clock add-icon" style="color:white; font-size:24px"></i><span class="add-label">Clock</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('weather', 3, 2)">
            <i class="fa-solid fa-cloud-sun add-icon" style="color:var(--ios-yellow); font-size:24px"></i><span class="add-label">Weather</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('todo', 3, 4)">
            <i class="fa-solid fa-check-circle add-icon" style="color:var(--ios-orange); font-size:24px"></i><span class="add-label">Tasks</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('music', 3, 3)">
            <i class="fa-brands fa-spotify add-icon" style="color:#1DB954; font-size:24px"></i><span class="add-label">Music</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('calc', 3, 4)">
            <i class="fa-solid fa-calculator add-icon" style="color:var(--ios-green); font-size:24px"></i><span class="add-label">Calc</span>
        </div>
        <div class="add-card" onclick="Core.createWidget('notes', 6, 3)">
            <i class="fa-solid fa-note-sticky add-icon" style="color:var(--ios-yellow); font-size:24px"></i><span class="add-label">Notes</span>
        </div>
        <div class="add-card" style="background:rgba(255,69,58,0.1)" onclick="UI.toggleAdd(false)">
            <i class="fa-solid fa-xmark add-icon" style="color:var(--ios-red); font-size:24px"></i><span class="add-label" style="color:var(--ios-red)">Close</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
    
    <script>
        const Utils = {
            calc: (id, val) => {
                const s = document.getElementById(`scr-${id}`);
                if (val === '=') { try { s.innerText = eval(s.innerText.replace('×','*').replace('÷','/')); } catch { s.innerText = "Error"; } }
                else if (val === 'C') { s.innerText = ''; }
                else s.innerText += val;
            },
            // Stream Deck Logic
            linkAction: (id, index, btn) => {
                const saved = JSON.parse(btn.getAttribute('data-link') || 'null');
                if (saved && saved.url) {
                    window.open(saved.url.startsWith('http') ? saved.url : 'https://' + saved.url, '_blank');
                } else {
                    Utils.editLink(id, index, btn);
                }
            },
            editLink: (id, index, btn) => {
                const url = prompt("Enter URL (e.g., google.com):", "");
                if (url) {
                    const name = prompt("Enter Label (e.g., Google):", "Link");
                    const data = { url, name };
                    btn.setAttribute('data-link', JSON.stringify(data));
                    btn.innerHTML = `<i class="fa-solid fa-globe deck-icon" style="color:var(--ios-blue)"></i><span class="deck-label">${name}</span>`;
                    Core.saveLayout();
                }
            },
            // Countdown Logic
            setCountdown: (id) => {
                const date = prompt("Enter date (YYYY-MM-DD):");
                if (!date) return;
                const name = prompt("Event Name:", "Event");
                const widget = document.getElementById(`count-wrap-${id}`);
                widget.setAttribute('data-target', JSON.stringify({date, name}));
                Utils.updateCountdown(id);
                Core.saveLayout();
            },
            updateCountdown: (id) => {
                const widget = document.getElementById(`count-wrap-${id}`);
                if (!widget) return;
                const data = JSON.parse(widget.getAttribute('data-target') || 'null');
                
                if (data) {
                    const target = new Date(data.date).getTime();
                    const now = new Date().getTime();
                    const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
                    
                    document.getElementById(`cd-val-${id}`).innerText = diff > 0 ? diff : 0;
                    document.getElementById(`cd-lbl-${id}`).innerText = diff > 0 ? `Days until ${data.name}` : `${data.name} is here!`;
                    // Visual progress bar logic (clamped 0-100 for effect)
                    const total = 30; // Assume 30 day visualization window
                    const pct = Math.max(0, Math.min(100, (diff / total) * 100));
                    document.getElementById(`cd-bar-${id}`).style.width = (100 - pct) + '%';
                }
            }
        };

        const Core = (() => {
            let grid = null, editing = false;

            const init = () => {
                grid = GridStack.init({ column: 12, cellHeight: '85px', margin: 12, float: true, animate: true });
                loadData();
                setInterval(UI.updateTime, 1000);
                
                // Update countdowns periodically
                setInterval(() => {
                    document.querySelectorAll('.count-container').forEach(el => {
                        const id = el.id.replace('count-wrap-', '');
                        Utils.updateCountdown(id);
                    });
                }, 60000); // Every minute
            };

            const toggleEdit = () => {
                editing = !editing;
                grid.enableMove(editing); grid.enableResize(editing);
                document.body.classList.toggle('editing', editing);
                document.getElementById('edit-btn').innerHTML = editing ? '<i class="fa-solid fa-check"></i> Done' : '<i class="fa-solid fa-pen-nib"></i> Edit';
            };

            const createWidget = (type, w, h, x, y, savedData) => {
                const id = 'w-' + Math.random().toString(36).substr(2, 9);
                const content = Templates.get(type, id, savedData);
                const el = grid.addWidget({ w, h, x, y, content, minW: 2, minH: 2 });
                el.querySelector('.remove-widget').onclick = () => grid.removeWidget(el);
                
                if (type === 'todo') UI.initTodo(id, savedData);
                if (type === 'notes') UI.initNotes(id, savedData);
                if (type === 'weather') UI.initWeather(id);
                if (type === 'countdown' && savedData) Utils.updateCountdown(id);

                UI.toggleAdd(false);
                saveLayout();
            };

            const saveLayout = () => {
                const items = grid.getGridItems().map(el => {
                    const type = el.getAttribute('data-type');
                    let data = null;
                    if (type === 'notes') data = el.querySelector('textarea').value;
                    if (type === 'todo') data = Array.from(el.querySelectorAll('.todo-item')).map(i => ({t: i.innerText, d: i.classList.contains('done')}));
                    
                    // Save Link Data
                    if (type === 'links') {
                        data = [];
                        el.querySelectorAll('.deck-btn').forEach(btn => {
                            data.push(JSON.parse(btn.getAttribute('data-link') || 'null'));
                        });
                    }
                    // Save Countdown Data
                    if (type === 'countdown') {
                        const wrap = el.querySelector('.count-container');
                        data = JSON.parse(wrap.getAttribute('data-target') || 'null');
                    }

                    return { x: el.gridstackNode.x, y: el.gridstackNode.y, w: el.gridstackNode.w, h: el.gridstackNode.h, type, data };
                });
                localStorage.setItem('ss_stream_v1', JSON.stringify(items));
            };

            const loadData = () => {
                let saved = JSON.parse(localStorage.getItem('ss_stream_v1'));
                if(!saved) saved = JSON.parse(localStorage.getItem('ss_ios_v1')); // Migration

                if (saved) {
                    saved.forEach(s => createWidget(s.type, s.w, s.h, s.x, s.y, s.data));
                } else {
                    // Default Layout
                    createWidget('links', 4, 2, 0, 0); // Top Left
                    createWidget('clock', 4, 2, 4, 0); // Top Middle
                    createWidget('countdown', 2, 2, 8, 0); // Top Right
                    createWidget('weather', 2, 2, 10, 0);
                    
                    createWidget('todo', 3, 4, 0, 2);
                    createWidget('calc', 3, 4, 3, 2);
                    createWidget('music', 3, 3, 6, 2);
                }
            };

            return { init, toggleEdit, createWidget, saveLayout, reset: () => { localStorage.clear(); location.reload(); } };
        })();

        const UI = {
            toggleAdd: (show) => document.getElementById('add-panel').classList.toggle('show', show),
            updateTime: () => {
                const now = new Date();
                // Clock Update - Short Time, Long Date
                document.querySelectorAll('.time-big').forEach(el => el.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}));
                document.querySelectorAll('.date-sub').forEach(el => el.innerText = now.toLocaleDateString(undefined, {weekday:'long', month:'short', day:'numeric'}));
            },
            initTodo: (id, data) => {
                const list = document.getElementById(`list-${id}`);
                const add = (t, d) => {
                    const i = document.createElement('div'); i.className = `todo-item ${d?'done':''}`; i.innerHTML = `<i class="fa-regular ${d?'fa-circle-check':'fa-circle'}"></i> ${t}`;
                    i.onclick = () => { i.classList.toggle('done'); i.querySelector('i').className = `fa-regular ${i.classList.contains('done')?'fa-circle-check':'fa-circle'}`; Core.saveLayout(); };
                    i.oncontextmenu = (e) => { e.preventDefault(); i.remove(); Core.saveLayout(); };
                    list.appendChild(i);
                }
                document.getElementById(`in-${id}`).onkeypress = (e) => { if(e.key === 'Enter' && e.target.value) { add(e.target.value, false); e.target.value=''; Core.saveLayout(); } };
                if(data) data.forEach(d => add(d.t, d.d));
            },
            initNotes: (id, data) => { const el = document.getElementById(`nt-${id}`); if(data) el.value = data; el.oninput = () => Core.saveLayout(); },
            initWeather: (id) => {
                navigator.geolocation.getCurrentPosition(pos => {
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
                    .then(r=>r.json()).then(d => {
                        const el = document.getElementById(`temp-${id}`); if(el) el.innerText = Math.round(d.current_weather.temperature) + '°';
                    });
                }, () => {}, {timeout:5000});
            }
        };

        const Templates = {
            get: (type, id, data) => {
                const wrap = (l, c) => `<div class="remove-widget">✕</div><div class="w-header" data-type="${type}"><span class="w-label">${l}</span></div><div class="w-content" data-type="${type}">${c}</div>`;
                
                // Helper for Links
                const getLinkBtn = (idx, saved) => {
                    const hasData = saved && saved.name;
                    return `<div class="deck-btn" onclick="Utils.linkAction('${id}', ${idx}, this)" oncontextmenu="event.preventDefault(); Utils.editLink('${id}', ${idx}, this)" data-link='${hasData ? JSON.stringify(saved) : ""}'>
                        ${hasData ? `<i class="fa-solid fa-globe deck-icon" style="color:var(--ios-blue)"></i><span class="deck-label">${saved.name}</span>` : `<i class="fa-solid fa-plus deck-icon deck-unset"></i>`}
                    </div>`;
                };

                // Helper for Countdown Data
                const hasCD = data && data.date;
                const cdStr = hasCD ? JSON.stringify(data) : "";

                const map = {
                    // NEW: Clock (Fixed Layout)
                    clock: `<div class="remove-widget">✕</div><div class="clock-container"><div class="time-big">00:00</div><div class="date-sub">Loading...</div></div>`,
                    
                    // NEW: Stream Deck Links
                    links: wrap('Quick Links', `<div class="deck-grid">
                        ${getLinkBtn(0, data?.[0])}
                        ${getLinkBtn(1, data?.[1])}
                        ${getLinkBtn(2, data?.[2])}
                    </div>`),

                    // NEW: Countdown
                    countdown: `<div class="remove-widget">✕</div>
                    <div class="count-container" id="count-wrap-${id}" onclick="Utils.setCountdown('${id}')" data-target='${cdStr}'>
                        <div class="count-days" id="cd-val-${id}">${hasCD ? '--' : '+'}</div>
                        <div class="count-label" id="cd-lbl-${id}">${hasCD ? 'Loading...' : 'Set Date'}</div>
                        <div class="count-progress"><div class="count-fill" id="cd-bar-${id}" style="width:0%"></div></div>
                    </div>`,

                    weather: wrap('Weather', `<div style="display:flex;align-items:center;justify-content:center;gap:15px;height:100%"><i class="fa-solid fa-cloud-sun" style="font-size:32px;color:var(--text-main)"></i><div><div id="temp-${id}" style="font-size:28px;font-weight:400">--°</div><div style="font-size:11px;color:var(--text-sec)">Mostly Clear</div></div></div>`),
                    todo: wrap('Reminders', `<div style="display:flex;gap:5px;margin-bottom:6px"><input id="in-${id}" placeholder="New Reminder..."><button class="btn" style="padding:0 10px;background:var(--ios-blue)" onclick="document.getElementById('list-${id}').innerHTML='';Core.saveLayout()"><i class="fa-solid fa-trash"></i></button></div><div id="list-${id}" style="flex:1;overflow-y:auto"></div>`),
                    music: wrap('Music', `<div style="text-align:center;display:flex;flex-direction:column;justify-content:center;height:100%"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="width:40px;height:40px;background:#333;border-radius:6px;display:flex;align-items:center;justify-content:center"><i class="fa-brands fa-spotify" style="color:#1DB954;font-size:24px"></i></div><div style="text-align:left"><div style="font-weight:600;font-size:12px">Not Playing</div><div style="font-size:10px;color:var(--text-sec)">iPhone</div></div></div><div style="display:flex;justify-content:center;gap:20px;font-size:20px;color:var(--text-main)"><i class="fa-solid fa-backward-step"></i><i class="fa-solid fa-play"></i><i class="fa-solid fa-forward-step"></i></div></div>`),
                    calc: wrap('Calculator', `<div id="scr-${id}" class="calc-screen">0</div><div class="calc-grid">${['C','÷','×','7','8','9','4','5','6','1','2','3','0','.','='].map(k=>`<button class="calc-btn ${['C','÷','×','='].includes(k)?'calc-orange':''}" onclick="Utils.calc('${id}','${k}')">${k}</button>`).join('')}</div>`),
                    notes: wrap('Notes', `<textarea id="nt-${id}" style="flex:1;resize:none;background:transparent;border:none;padding:0;font-family:inherit;font-size:14px;line-height:1.4" placeholder="New Note..."></textarea>`)
                };
                return map[type] || `<div>Error: ${type}</div>`;
            }
        };

        window.onload = Core.init;
    </script>
</body>
</html>
