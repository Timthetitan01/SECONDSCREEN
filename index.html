<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondScreen | Pro Tier</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-body: #000000;
            --ios-card: rgba(28, 28, 30, 0.65);
            --ios-card-border: rgba(255, 255, 255, 0.12);
            --ios-input: rgba(118, 118, 128, 0.24);
            --ios-blue: #0A84FF; --ios-green: #30D158; --ios-red: #FF453A;
            --text-main: #FFFFFF; --text-sec: rgba(235, 235, 245, 0.6);
            --radius: 22px;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; user-select: none; }

        body {
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 20% 0%, rgba(94, 92, 230, 0.25) 0%, transparent 50%),
                radial-gradient(circle at 80% 100%, rgba(10, 132, 255, 0.2) 0%, transparent 50%);
            color: var(--text-main); font-family: var(--font); height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* STATUS BAR */
        #status-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; border: 1px solid var(--ios-card-border);
            display: none; z-index: 5000; pointer-events: none; transition: opacity 0.3s;
        }

        /* ACTION TOAST */
        #action-toast {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(48, 209, 88, 0.9);
            color: white; padding: 10px 24px;
            border-radius: 50px; font-size: 14px; font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; z-index: 6000; pointer-events: none;
            backdrop-filter: blur(10px);
            animation: popUpFade 2s ease forwards;
        }

        @keyframes popUpFade {
            0% { opacity: 0; transform: translate(-50%, 10px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            80% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -10px); }
        }

        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 20px;
            transition: opacity 0.5s ease;
        }
        .login-card {
            background: #1c1c1e; border: 1px solid var(--ios-card-border);
            padding: 40px; border-radius: 24px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            max-width: 400px; width: 90%;
        }
        .login-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .login-sub { color: var(--text-sec); font-size: 14px; margin-bottom: 25px; line-height: 1.4; }
        
        #error-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 69, 58, 0.9); color: white; padding: 10px 20px;
            border-radius: 50px; font-size: 13px; z-index: 10000;
            display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        input, textarea { 
            user-select: text !important; -webkit-user-select: text !important; cursor: text; 
            background: var(--ios-input); border: none; border-radius: 8px; 
            padding: 8px 12px; color: white; width: 100%; font-size: 13px; outline: none;
        }
        input:focus, textarea:focus { background: rgba(118, 118, 128, 0.4); }

        nav { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(20, 20, 20, 0.4); backdrop-filter: blur(20px); border-bottom: 1px solid var(--ios-card-border); z-index: 1000; }
        .brand { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .nav-actions { display: flex; gap: 10px; align-items: center; }

        .btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 6px 14px; border-radius: 99px; font-size: 13px; font-weight: 500; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .btn:hover { background: rgba(255, 255, 255, 0.2); }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .btn-primary { background: var(--ios-blue); }
        .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--ios-red); }
        .btn-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: black; border: 1px solid #FFD700; font-weight: 700; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
        .btn-gold:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

        .user-pill { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 4px 12px 4px 4px; border-radius: 99px; }
        .user-avatar { width: 24px; height: 24px; border-radius: 50%; background: #555; }
        .user-name { font-size: 12px; font-weight: 500; }
        .pro-badge { background: #FFD700; color: black; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; margin-left: 5px; }

        #dashboard-wrapper { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; cursor: default; }
        .grid-stack-item { overflow: visible !important; }
        .grid-stack-item-content { background: var(--ios-card) !important; backdrop-filter: var(--blur) !important; border: 1px solid var(--ios-card-border) !important; border-radius: var(--radius) !important; padding: 16px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }

        .remove-widget { position: absolute; top: -10px; right: -10px; width: 26px; height: 26px; background: #8e8e93; border: 2px solid var(--bg-body); border-radius: 50%; color: white; display: none; justify-content: center; align-items: center; font-size: 12px; cursor: pointer; z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .editing .remove-widget { display: flex; animation: popIn 0.2s; }
        .editing .grid-stack-item-content { cursor: grab; animation: jiggle 0.3s infinite ease-in-out; border-color: var(--ios-blue) !important; }
        .editing .grid-stack-item-content:active { cursor: grabbing; }
        .editing input, .editing textarea { cursor: text !important; }
        .editing .weather-temp { cursor: pointer; color: var(--ios-blue) !important; text-decoration: underline; text-decoration-style: dotted; }

        @keyframes jiggle { 0% { transform: rotate(-0.8deg); } 50% { transform: rotate(0.8deg); } 100% { transform: rotate(-0.8deg); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .w-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; height: 16px; flex-shrink: 0; transition: 0.2s; }
        .w-label { font-size: 11px; font-weight: 600; color: var(--ios-blue); text-transform: uppercase; letter-spacing: 0.5px; }
        .w-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* Widget Styles */
        .batt-container { display: flex; align-items: center; justify-content: center; height: 100%; gap: 15px; }
        .batt-icon-shell { width: 50px; height: 26px; border: 3px solid var(--text-sec); border-radius: 6px; padding: 2px; position: relative; }
        .batt-icon-shell::after { content:''; position: absolute; right: -6px; top: 6px; width: 3px; height: 8px; background: var(--text-sec); border-radius: 0 2px 2px 0; }
        .batt-fill { height: 100%; background: var(--ios-green); border-radius: 2px; width: 0%; transition: width 0.5s; }
        .batt-text { font-size: 28px; font-weight: 600; }
        .batt-state { font-size: 11px; color: var(--text-sec); text-align: center; margin-top: 5px; }

        .pass-display { font-family: monospace; font-size: 16px; text-align: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 10px; color: var(--ios-green); word-break: break-all; cursor: pointer; transition: background 0.2s; }
        .pass-display:hover { background: rgba(0,0,0,0.5); }
        .pass-controls { display: flex; gap: 10px; align-items: center; }
        
        .clip-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
        .clip-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; font-size: 11px; cursor: pointer; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .clip-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .clip-item:active { transform: scale(0.98); }

        .timer-container { display: flex; flex-direction: column; justify-content: center; height: 100%; cursor: pointer; }
        .timer-big { font-size: 36px; font-weight: 700; text-align: center; font-variant-numeric: tabular-nums; line-height: 1; margin-bottom: 5px; }
        .timer-label { font-size: 12px; color: var(--text-sec); text-align: center; }
        .timer-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--ios-orange); width: 100%; transition: width 1s linear; }

        .task-input-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .task-list { flex: 1; overflow-y: auto; padding-right: 2px; }
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; }
        .task-item.done .task-check { background: var(--ios-blue); border-color: var(--ios-blue); color: white; }
        .task-item.done .task-text { text-decoration: line-through; color: var(--text-sec); }
        .task-text { font-size: 13px; flex: 1; pointer-events: none; transition: color 0.2s; }
        .task-check { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #636366; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: transparent; font-size: 10px; }
        .task-delete { color: var(--text-sec); opacity: 0; transition: 0.2s; font-size: 12px; padding: 4px; }
        .task-item:hover .task-delete { opacity: 1; }
        .task-empty { text-align: center; color: var(--text-sec); font-size: 12px; margin-top: 20px; font-style: italic; opacity: 0.7; }

        .calc-screen { text-align:right; font-size:42px; font-weight:200; margin-bottom:10px; height:50px; white-space:nowrap; overflow:hidden; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; }
        .calc-btn { background: rgba(255,255,255,0.1); border:none; color:white; border-radius:50px; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .calc-btn:active { background: rgba(255,255,255,0.3); }
        .calc-orange { background: var(--ios-orange); font-weight: 600; }
        
        .clock-container { display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; }
        .time-big { font-size: 48px; font-weight: 200; letter-spacing: -1px; line-height: 1; margin-bottom: 5px; white-space: nowrap; }
        .date-sub { font-size: 15px; color: var(--ios-red); font-weight: 500; text-transform: uppercase; }

        .deck-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; height: 100%; }
        .deck-btn { background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; }
        .deck-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); box-shadow: 0 0 15px var(--ios-blue); border-color: var(--ios-blue); }
        .deck-icon { font-size: 24px; color: var(--text-main); }
        .deck-favicon { width: 32px; height: 32px; border-radius: 8px; margin-bottom: 2px; object-fit: contain; pointer-events: none; }
        .deck-label { font-size: 10px; font-weight: 600; color: var(--text-sec); text-align: center; width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .deck-unset { color: var(--text-sec); opacity: 0.5; font-size: 20px; }

        .count-container { display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; cursor: pointer; }
        .count-days { font-size: 42px; font-weight: 700; line-height: 1; margin-bottom: 4px; }
        .count-label { font-size: 12px; color: var(--text-sec); font-weight: 500; }
        .count-progress { height: 4px; background: rgba(255,255,255,0.1); margin-top: 10px; border-radius: 2px; width: 80%; margin-left: auto; margin-right: auto; overflow: hidden; }
        .count-fill { height: 100%; background: var(--ios-indigo); width: 0%; transition: width 1s ease; }

        .cal-wrapper { height: 100%; display: flex; flex-direction: column; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 600; font-size: 14px; }
        .cal-title { cursor: pointer; transition: color 0.2s; }
        .cal-title:hover { color: var(--ios-red); }
        .cal-nav { cursor: pointer; padding: 4px; color: var(--ios-red); font-size: 14px; transition: transform 0.2s; }
        .cal-nav:hover { transform: scale(1.2); }
        .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 10px; font-weight: 600; color: var(--text-sec); margin-bottom: 6px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; flex: 1; align-content: start; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 50%; cursor: default; transition: 0.2s; }
        .cal-day:hover:not(.empty) { background: rgba(255,255,255,0.1); }
        .cal-day.today { background: var(--ios-red); color: white; font-weight: 700; }
        .cal-day.empty { pointer-events: none; }
        
        /* YouTube & Spotify Widgets */
        .yt-container { height: 100%; display: flex; flex-direction: column; position: relative; }
        .yt-setup { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
        .yt-frame { flex: 1; width: 100%; border: none; border-radius: 12px; }
        .yt-input { background: var(--ios-input); border: none; color: white; padding: 8px; border-radius: 8px; width: 80%; text-align: center; }
        .yt-controls { position: absolute; top: 5px; right: 5px; z-index: 10; opacity: 0; transition: 0.2s; }
        .grid-stack-item:hover .yt-controls { opacity: 1; }
        
        .sp-container { height: 100%; display: flex; flex-direction: column; position: relative; }
        .sp-setup { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; text-align: center; }
        .sp-frame { flex: 1; width: 100%; border: none; border-radius: 12px; }

        /* Modal */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); z-index: 1999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #modal-overlay.show { opacity: 1; pointer-events: all; }
        #add-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 90%; max-width: 500px; max-height: 80vh; background: rgba(28, 28, 30, 0.95); border: 1px solid var(--ios-card-border); border-radius: 24px; padding: 24px; z-index: 2000; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        #add-modal.show { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; color: white; }
        .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; overflow-y: auto; padding: 2px; }
        .add-card { background: rgba(255,255,255,0.08); padding: 15px; border-radius: 18px; text-align: center; cursor: pointer; transition: 0.2s; display:flex; flex-direction:column; align-items:center; gap:10px; height: 100px; justify-content: center; }
        .add-card:hover { background: rgba(255,255,255,0.12); transform: translateY(-2px); }
        .add-card:active { transform: scale(0.96); }
        .add-label { font-size: 11px; font-weight: 500; color: white; }
        .add-icon { font-size: 28px; margin-bottom: 2px; }

        ::-webkit-scrollbar { width: 0px; } 
    </style>
</head>
<body>

    <div id="status-bar">Syncing...</div>

    <div id="action-toast">Copied!</div>

    <div id="error-toast"></div>

    <div id="login-overlay">
        <div class="login-card">
            <div class="login-title"><i class="fa-brands fa-apple"></i> SecondScreen Pro</div>
            <div class="login-sub">Sign in with Google to load your dashboard.</div>
            <button class="btn btn-primary" style="font-size:16px; padding:12px 24px" onclick="Cloud.login()">
                <i class="fa-brands fa-google"></i> Sign in with Google
            </button>
        </div>
    </div>

    <div id="modal-overlay" onclick="UI.toggleAdd(false)"></div>
    <div id="add-modal">
        <div class="modal-header">
            <div class="modal-title">Gallery</div>
            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="UI.toggleAdd(false)">Close</button>
        </div>
        <div class="modal-grid">
            <div class="add-card" onclick="Core.createWidget('spotify', 4, 5)"><i class="fa-brands fa-spotify add-icon" style="color:#1DB954"></i><span class="add-label">Spotify</span></div>
            <div class="add-card" onclick="Core.createWidget('youtube', 4, 3)"><i class="fa-brands fa-youtube add-icon" style="color:#FF0000"></i><span class="add-label">YouTube</span></div>
            <div class="add-card" onclick="Core.createWidget('timer', 3, 2)"><i class="fa-solid fa-hourglass-end add-icon" style="color:var(--ios-orange)"></i><span class="add-label">Timer</span></div>
            <div class="add-card" onclick="Core.createWidget('battery', 3, 2)"><i class="fa-solid fa-battery-half add-icon" style="color:var(--ios-green)"></i><span class="add-label">Battery</span></div>
            <div class="add-card" onclick="Core.createWidget('password', 4, 3)"><i class="fa-solid fa-key add-icon" style="color:var(--ios-purple)"></i><span class="add-label">Passwords</span></div>
            <div class="add-card" onclick="Core.createWidget('clipboard', 3, 4)"><i class="fa-solid fa-clipboard add-icon" style="color:var(--ios-teal)"></i><span class="add-label">Clipboard</span></div>
            <div class="add-card" onclick="Core.createWidget('calendar', 4, 4)"><i class="fa-regular fa-calendar add-icon" style="color:var(--ios-red)"></i><span class="add-label">Calendar</span></div>
            <div class="add-card" onclick="Core.createWidget('links', 4, 2)"><i class="fa-solid fa-gamepad add-icon" style="color:var(--ios-blue)"></i><span class="add-label">Quick Links</span></div>
            <div class="add-card" onclick="Core.createWidget('countdown', 2, 2)"><i class="fa-solid fa-hourglass-half add-icon" style="color:var(--ios-indigo)"></i><span class="add-label">Countdown</span></div>
            <div class="add-card" onclick="Core.createWidget('clock', 4, 2)"><i class="fa-regular fa-clock add-icon" style="color:white"></i><span class="add-label">Clock</span></div>
            <div class="add-card" onclick="Core.createWidget('weather', 3, 2)"><i class="fa-solid fa-cloud-sun add-icon" style="color:var(--ios-yellow)"></i><span class="add-label">Weather</span></div>
            <div class="add-card" onclick="Core.createWidget('todo', 3, 4)"><i class="fa-solid fa-check-circle add-icon" style="color:var(--ios-orange)"></i><span class="add-label">Reminders</span></div>
            <div class="add-card" onclick="Core.createWidget('music', 3, 3)"><i class="fa-brands fa-spotify add-icon" style="color:#1DB954"></i><span class="add-label">Music (Auth)</span></div>
            <div class="add-card" onclick="Core.createWidget('calc', 3, 5)"><i class="fa-solid fa-calculator add-icon" style="color:var(--ios-green)"></i><span class="add-label">Calculator</span></div>
            <div class="add-card" onclick="Core.createWidget('notes', 6, 3)"><i class="fa-solid fa-note-sticky add-icon" style="color:var(--ios-yellow)"></i><span class="add-label">Notes</span></div>
        </div>
    </div>

    <nav>
        <div class="brand"><i class="fa-brands fa-apple"></i> SecondScreen Pro</div>
        <div class="nav-actions">
            <button id="upgrade-btn" class="btn btn-gold" onclick="Cloud.upgrade()" style="display:none">
                <i class="fa-solid fa-star"></i> Upgrade
            </button>
            <button class="btn btn-primary" onclick="UI.toggleAdd(true)"><i class="fa-solid fa-plus"></i> Add</button>
            <button id="edit-btn" class="btn" onclick="Core.toggleEdit()"><i class="fa-solid fa-pen-nib"></i> Edit</button>
            <button class="btn" onclick="Cloud.logout()"><i class="fa-solid fa-power-off"></i></button>
            <div id="user-info"></div>
            <div class="user-pill"></div>
        </div>
    </nav>

    <div id="dashboard-wrapper">
        <div class="grid-stack"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
    
    <script>
        
// === SPOTIFY CONFIGURATION ===
const SPOTIFY_CLIENT_ID = "2aea224b957a49e0ade20938094a2170"; 
const SPOTIFY_SCOPES = "playlist-read-private playlist-read-collaborative";

const firebaseConfig = {
  apiKey: "AIzaSyArqMp658OSK8u46cjCefyVKiDJe4oe8-g",
  authDomain: "secondscreen-f7cd9.firebaseapp.com",
  projectId: "secondscreen-f7cd9",
  storageBucket: "secondscreen-f7cd9.firebasestorage.app",
  messagingSenderId: "233696091813",
  appId: "1:233696091813:web:734ed34d527ba05dbbf74c",
  measurementId: "G-QTQZ0ET1KJ"
};

        // --- 2. STRIPE CONFIG ---
        const STRIPE_LINK = "https://buy.stripe.com/test_..."; // PASTE YOUR STRIPE PAYMENT LINK HERE

        try {
            if(firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                firebase.initializeApp(firebaseConfig);
                var db = firebase.firestore();
                var auth = firebase.auth();
                var provider = new firebase.auth.GoogleAuthProvider();
            }
        } catch(e) { console.warn("Firebase not configured."); }

        // GLOBAL LOADING LOCK & PRO STATUS
        let isDashboardLoaded = false;
        let isPro = false;

        const Cloud = {
            user: null,
            login: () => {
                auth.signInWithPopup(provider).catch(e => alert(e.message));
            },
            logout: () => {
                auth.signOut().then(() => location.reload());
            },
            initAuth: () => {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        Cloud.user = user;
                        document.getElementById('login-overlay').style.opacity = '0';
                        setTimeout(() => document.getElementById('login-overlay').style.display = 'none', 500);
                        Core.loadData();
                    } else {
                        document.getElementById('login-overlay').style.display = 'flex';
                        document.getElementById('login-overlay').style.opacity = '1';
                    }
                });
            },
            save: (data) => {
                if(Cloud.user && db) {
                    const status = document.getElementById('status-bar');
                    status.style.display = 'block';
                    status.innerText = "Saving...";
                    
                    // SAVE WITH MERGE TRUE to not overwrite 'isPro' status
                    db.collection('users').doc(Cloud.user.uid).set({ 
                        layout: JSON.stringify(data), 
                        updated: Date.now() 
                    }, { merge: true }).then(() => {
                        status.innerText = "Saved";
                        setTimeout(() => status.style.display = 'none', 1500);
                    }).catch(e => {
                        console.error(e);
                        status.innerText = "Error Saving";
                    });
                }
            },
            upgrade: () => {
                window.open(STRIPE_LINK, '_blank');
                alert("After payment, please contact support (you) to activate Pro status.");
            }
        };

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const Utils = {
            calc: (id, val) => {
                const s = document.getElementById(`scr-${id}`);
                if (val === '=') { try { s.innerText = eval(s.innerText.replace('×','*').replace('÷','/')); } catch { s.innerText = "Error"; } }
                else if (val === 'C') { s.innerText = ''; }
                else s.innerText += val;
            },
            linkAction: (id, index, btn) => {
                const saved = JSON.parse(btn.getAttribute('data-link') || 'null');
                if (saved && saved.url) { window.open(saved.url, '_blank'); } 
                else { Utils.editLink(id, index, btn); }
            },
            editLink: (id, index, btn) => {
                let url = prompt("Enter URL (e.g., google.com):", "");
                if (url) {
                    if (!url.startsWith('http://') && !url.startsWith('https://')) { url = 'https://' + url; }
                    let domain; try { domain = new URL(url).hostname; } catch(e) { domain = url; }
                    const name = prompt("Label:", "Link");
                    const data = { url, name, domain };
                    btn.setAttribute('data-link', JSON.stringify(data));
                    btn.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=64" class="deck-favicon"><span class="deck-label">${name}</span>`;
                    Core.saveLayout();
                }
            },
            setCountdown: (id) => {
                const date = prompt("YYYY-MM-DD:");
                if (!date) return;
                const name = prompt("Event Name:", "Event");
                const widget = document.getElementById(`count-wrap-${id}`);
                widget.setAttribute('data-target', JSON.stringify({date, name}));
                Utils.updateCountdown(id);
                Core.saveLayout();
            },
            updateCountdown: (id) => {
                const widget = document.getElementById(`count-wrap-${id}`);
                if (!widget) return;
                const data = JSON.parse(widget.getAttribute('data-target') || 'null');
                if (data) {
                    const diff = Math.ceil((new Date(data.date).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
                    document.getElementById(`cd-val-${id}`).innerText = diff > 0 ? diff : 0;
                    document.getElementById(`cd-lbl-${id}`).innerText = diff > 0 ? `Days until ${data.name}` : `${data.name} is here!`;
                    const pct = Math.max(0, Math.min(100, (diff / 30) * 100));
                    document.getElementById(`cd-bar-${id}`).style.width = (100 - pct) + '%';
                }
            },
            initCalendar: (id) => { if(!window[`cal_date_${id}`]) { window[`cal_date_${id}`] = new Date(); } Utils.renderCalendar(id); },
            changeMonth: (id, offset) => { const currentDate = window[`cal_date_${id}`]; currentDate.setMonth(currentDate.getMonth() + offset); Utils.renderCalendar(id); },
            resetCalendar: (id) => { window[`cal_date_${id}`] = new Date(); Utils.renderCalendar(id); },
            renderCalendar: (id) => {
                const date = window[`cal_date_${id}`];
                const year = date.getFullYear();
                const month = date.getMonth();
                document.getElementById(`cal-title-${id}`).innerText = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const daysContainer = document.getElementById(`cal-grid-${id}`);
                daysContainer.innerHTML = '';
                const firstDayIndex = new Date(year, month, 1).getDay();
                const lastDay = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                for (let i = 0; i < firstDayIndex; i++) { const empty = document.createElement('div'); empty.classList.add('cal-day', 'empty'); daysContainer.appendChild(empty); }
                for (let i = 1; i <= lastDay; i++) {
                    const dayEl = document.createElement('div'); dayEl.classList.add('cal-day'); dayEl.innerText = i;
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) { dayEl.classList.add('today'); }
                    daysContainer.appendChild(dayEl);
                }
            },
            setTimer: (id) => {
                const time = prompt("Enter Time (e.g. 5:00 PM or 17:00):");
                if(!time) return;
                const d = new Date(); const [timeStr, mod] = time.split(' '); let [h, m] = timeStr.split(':');
                if (h === '12') h = '00'; if (mod && (mod.toLowerCase() === 'pm')) h = parseInt(h, 10) + 12;
                d.setHours(h, m, 0, 0);
                if(d < new Date()) { alert("Time passed!"); return; }
                document.getElementById(`timer-wrap-${id}`).setAttribute('data-end', d.getTime());
                document.getElementById(`timer-lbl-${id}`).innerText = `Until ${time}`;
                Utils.updateTimer(id); Core.saveLayout();
            },
            updateTimer: (id) => {
                const el = document.getElementById(`timer-wrap-${id}`); if(!el) return;
                const end = parseInt(el.getAttribute('data-end')); if(!end) return;
                const diff = end - Date.now();
                if(diff <= 0) { document.getElementById(`timer-val-${id}`).innerText = "Done"; return; }
                const hr = Math.floor((diff % (86400000)) / (3600000));
                const mn = Math.floor((diff % (3600000)) / 60000);
                document.getElementById(`timer-val-${id}`).innerText = `${hr}h ${mn}m`;
            },
            updateBattery: async (id) => {
                if('getBattery' in navigator) {
                    const batt = await navigator.getBattery();
                    const up = () => {
                        const lvl = Math.round(batt.level * 100);
                        document.getElementById(`batt-val-${id}`).innerText = lvl + '%';
                        document.getElementById(`batt-fill-${id}`).style.width = lvl + '%';
                        document.getElementById(`batt-st-${id}`).innerText = batt.charging ? 'Charging ⚡' : 'On Battery';
                        document.getElementById(`batt-fill-${id}`).style.background = batt.charging ? 'var(--ios-green)' : (lvl<20?'var(--ios-red)':'var(--text-main)');
                    }; up(); batt.addEventListener('levelchange', up); batt.addEventListener('chargingchange', up);
                } else { document.getElementById(`batt-st-${id}`).innerText = "Not Supported"; }
            },
            genPass: (id) => {
                const len = document.getElementById(`rng-${id}`).value;
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%^&*";
                let pass = ""; for(let i=0; i<len; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
                document.getElementById(`pass-${id}`).innerText = pass;
                document.getElementById(`lbl-${id}`).innerText = `Length: ${len}`;
            },
            saveClip: async (id) => {
                try {
                    const text = await navigator.clipboard.readText(); if(!text) return;
                    const list = document.getElementById(`clip-${id}`);
                    const item = document.createElement('div'); item.className = 'clip-item'; item.innerText = text;
                    item.onclick = () => { navigator.clipboard.writeText(text); UI.showToast("Copied to Clipboard!"); };
                    list.prepend(item); if(list.children.length > 5) list.lastChild.remove();
                    Core.saveLayout();
                } catch(e) { alert("Clipboard permission required"); }
            },
            copyPass: (id) => {
                const text = document.getElementById(`pass-${id}`).innerText;
                if(text && text !== "CLICK GEN") {
                    navigator.clipboard.writeText(text);
                    UI.showToast("Password Copied!");
                }
            },

            // --- SPOTIFY MUSIC WIDGET UTILS (CORRECTED) ---
loginSpotify: (id) => {
                if(SPOTIFY_CLIENT_ID.includes("INSERT")) { alert("Please edit the HTML file and add your Spotify Client ID."); return; }
                
                // Get the current page URL to use as the redirect
                const redirect = window.location.href.split('#')[0]; 
                
                // --- FIXED URL ---
                // We use the official accounts.spotify.com URL
                const url = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(redirect)}&scope=${encodeURIComponent(SPOTIFY_SCOPES)}&show_dialog=true`;
                
                const width = 450, height = 730, left = (screen.width/2)-(width/2), top = (screen.height/2)-(height/2);
                window.open(url, 'Spotify_Auth', `menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=${width}, height=${height}, top=${top}, left=${left}`);
            },
            
            handleSpotifyToken: (token) => {
                localStorage.setItem('sp_token', token);
                document.querySelectorAll('.music-header').forEach(el => {
                    const id = el.querySelector('select').id.replace('ms-sel-', '');
                    Utils.fetchSpotifyPlaylists(id);
                });
            },

            fetchSpotifyPlaylists: (id) => {
                const token = localStorage.getItem('sp_token');
                if(!token) return; 

                fetch('https://api.spotify.com/v1/me/playlists', {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(r => {
                    if(r.status === 401) { localStorage.removeItem('sp_token'); return; }
                    return r.json();
                })
                .then(data => {
                    if(!data || !data.items) return;
                    const select = document.getElementById(`ms-sel-${id}`);
                    const currentVal = select.value;
                    select.innerHTML = '<option value="">Select Playlist...</option>';
                    
                    data.items.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.uri; 
                        opt.innerText = p.name;
                        select.appendChild(opt);
                    });
                    
                    if(currentVal) select.value = currentVal;
                });
            },

            changeSpotifySource: (id) => {
                const select = document.getElementById(`ms-sel-${id}`);
                const iframe = document.getElementById(`ms-frame-${id}`);
                const setup = document.getElementById(`ms-setup-${id}`);
                
                if(select.value) {
                    const uri = select.value;
                    const parts = uri.split(':');
                    const type = parts[1];
                    const uid = parts[2];
                    const embedUrl = `https://open.spotify.com/embed/${type}/${uid}?utm_source=generator&theme=0`;
                    
                    iframe.src = embedUrl;
                    iframe.style.display = 'block';
                    setup.style.display = 'none';
                } else {
                    iframe.style.display = 'none';
                    setup.style.display = 'flex';
                }
                Core.saveLayout();
            },
            
            deleteMusic: (id) => { },
            
            // --- YOUTUBE WIDGET UTILS ---
            loadYT: (id) => {
                const input = document.getElementById(`yt-input-${id}`);
                const frame = document.getElementById(`yt-frame-${id}`);
                const setup = document.getElementById(`yt-setup-${id}`);
                const controls = document.getElementById(`yt-controls-${id}`);
                let url = input.value;
                let embedUrl = "";

                if(url.includes('list=')) { 
                    const listId = url.split('list=')[1].split('&')[0]; 
                    embedUrl = `https://www.youtube.com/embed/videoseries?list=${listId}`; 
                } else if(url.includes('v=')) { 
                    const vidId = url.split('v=')[1].split('&')[0]; 
                    embedUrl = `https://www.youtube.com/embed/${vidId}`; 
                } else if(url.includes('youtu.be/')) { 
                    const vidId = url.split('youtu.be/')[1].split('?')[0]; 
                    embedUrl = `https://www.youtube.com/embed/${vidId}`; 
                } else { return; }

                frame.src = embedUrl;
                setup.style.display = 'none';
                frame.style.display = 'block';
                controls.style.display = 'block';
                Core.saveLayout();
            },
            resetYT: (id) => {
                document.getElementById(`yt-frame-${id}`).src = "";
                document.getElementById(`yt-frame-${id}`).style.display = "none";
                document.getElementById(`yt-controls-${id}`).style.display = "none";
                document.getElementById(`yt-setup-${id}`).style.display = "flex";
                document.getElementById(`yt-input-${id}`).value = "";
                Core.saveLayout();
            },

            // --- SPOTIFY UTILS (EMBED VERSION) ---
            loadSpotify: (id) => {
                const input = document.getElementById(`sp-input-${id}`);
                const frame = document.getElementById(`sp-frame-${id}`);
                const setup = document.getElementById(`sp-setup-${id}`);
                const controls = document.getElementById(`sp-controls-${id}`);
                const url = input.value;
                
                let embedUrl = url.replace('https://open.spotify.com/', 'https://open.spotify.com/embed/');
                                  
                if(!embedUrl.includes('?')) embedUrl += "?utm_source=generator&theme=0";

                frame.src = embedUrl;
                setup.style.display = 'none';
                frame.style.display = 'block';
                controls.style.display = 'block';
                Core.saveLayout();
            },
            resetSpotify: (id) => {
                document.getElementById(`sp-frame-${id}`).src = "";
                document.getElementById(`sp-frame-${id}`).style.display = "none";
                document.getElementById(`sp-controls-${id}`).style.display = "none";
                document.getElementById(`sp-setup-${id}`).style.display = "flex";
                document.getElementById(`sp-input-${id}`).value = "";
                Core.saveLayout();
            },

            initWeather: (id, savedData) => {
                const el = document.getElementById(`temp-${id}`);
                const widget = el.closest('.grid-stack-item');
                let unit = savedData && savedData.unit ? savedData.unit : 'F';
                widget.setAttribute('data-unit', unit);

                navigator.geolocation.getCurrentPosition(pos => {
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
                    .then(r=>r.json()).then(d => {
                        const raw = d.current_weather.temperature;
                        widget.setAttribute('data-raw-temp', raw);
                        Utils.renderWeather(id);
                    });
                });

                el.onclick = () => {
                    if(document.body.classList.contains('editing')) {
                        let u = widget.getAttribute('data-unit');
                        u = u === 'F' ? 'C' : 'F';
                        widget.setAttribute('data-unit', u);
                        Utils.renderWeather(id);
                        Core.saveLayout();
                    }
                };
            },
            renderWeather: (id) => {
                const el = document.getElementById(`temp-${id}`);
                const widget = el.closest('.grid-stack-item');
                const raw = parseFloat(widget.getAttribute('data-raw-temp'));
                const unit = widget.getAttribute('data-unit');
                if(isNaN(raw)) return;
                let val = raw;
                if(unit === 'F') val = (raw * 9/5) + 32;
                el.innerText = Math.round(val) + '°' + unit;
            }
        };

        const Core = (() => {
            let grid = null, editing = false;

            const init = () => {
                // --- SPOTIFY POPUP HANDLER ---
                // Checks if this window was opened by a popup for auth
                if(window.opener) {
                    const hash = window.location.hash;
                    if(hash && hash.includes('access_token')) {
                        const token = hash.split('access_token=')[1].split('&')[0];
                        if(token) {
                            window.opener.Utils.handleSpotifyToken(token);
                            window.close();
                            return; // Stop execution in popup
                        }
                    }
                }
                
                grid = GridStack.init({ column: 12, cellHeight: '85px', margin: 12, float: true, animate: true, disableDrag: true, disableResize: true });
                grid.off('change added removed'); // IMPORTANT: No saving during init

                Cloud.initAuth();

                setInterval(UI.updateTime, 1000);
                setInterval(() => document.querySelectorAll('.count-container').forEach(el => Utils.updateCountdown(el.id.replace('count-wrap-', ''))), 60000);
                setInterval(() => { document.querySelectorAll('.timer-container').forEach(el => Utils.updateTimer(el.id.replace('timer-wrap-',''))); }, 1000);

                document.getElementById('dashboard-wrapper').addEventListener('click', (e) => {
                    if (editing && !e.target.closest('.grid-stack-item')) { Core.toggleEdit(); }
                });
            };

            const toggleEdit = () => {
                editing = !editing;
                grid.enableMove(editing); grid.enableResize(editing);
                document.body.classList.toggle('editing', editing);
                const btn = document.getElementById('edit-btn');
                if(editing) { btn.innerHTML = '<i class="fa-solid fa-check"></i> Done'; btn.classList.add('btn-primary'); } 
                else { btn.innerHTML = '<i class="fa-solid fa-pen-nib"></i> Edit'; btn.classList.remove('btn-primary'); }
            };

            const createWidget = (type, w, h, x, y, savedData) => {
                // --- LIMIT CHECK FOR FREE USERS ---
                if (!isPro && grid.getGridItems().length >= 2 && !isDashboardLoaded) {
                    // Logic allows existing widgets to load, but prevents adding new ones interactively
                }
                
                // If dashboard is loaded (meaning user is clicking ADD), check limit
                if (isDashboardLoaded && !isPro && grid.getGridItems().length >= 2) {
                    alert("Free Tier Limit Reached (2 Widgets). Upgrade to Pro for unlimited access!");
                    UI.toggleAdd(false);
                    return;
                }

                const id = 'w-' + Math.random().toString(36).substr(2, 9);
                const content = Templates.get(type, id, savedData);
                if (content === '<div>Error</div>') return;

                const el = grid.addWidget({ w, h, x, y, content, minW: 2, minH: 2 });
                el.setAttribute('data-type', type); 

                const removeBtn = el.querySelector('.remove-widget');
                if(removeBtn) { el.appendChild(removeBtn); removeBtn.onclick = () => { grid.removeWidget(el); Core.saveLayout(); }; }
                
                if (type === 'todo') UI.initTodo(id, savedData);
                if (type === 'notes') document.getElementById(`nt-${id}`).value = savedData || "";
                if (type === 'weather') Utils.initWeather(id, savedData);
                if (type === 'countdown' && savedData) Utils.updateCountdown(id);
                if (type === 'calendar') Utils.initCalendar(id);
                if (type === 'battery') Utils.updateBattery(id);
                if (type === 'clipboard' && savedData) {
                    savedData.forEach(t => {
                        const i = document.createElement('div'); i.className='clip-item'; i.innerText=t;
                        i.onclick = () => { navigator.clipboard.writeText(t); UI.showToast("Copied to Clipboard!"); };
                        document.getElementById(`clip-${id}`).appendChild(i);
                    });
                }
                if (type === 'timer' && savedData) {
                    const wrap = document.getElementById(`timer-wrap-${id}`);
                    wrap.setAttribute('data-end', savedData.end);
                    document.getElementById(`timer-lbl-${id}`).innerText = savedData.label;
                }
                
                // LOAD SPOTIFY MUSIC WIDGET
                if (type === 'music') {
                    // Try to load playlists if token exists
                    Utils.fetchSpotifyPlaylists(id);
                    // Load saved selection
                    if(savedData && savedData.current) {
                        const select = document.getElementById(`ms-sel-${id}`);
                        // Create option immediately so value can be set before fetch completes
                        if(savedData.currentName) {
                            const opt = document.createElement('option');
                            opt.value = savedData.current;
                            opt.innerText = savedData.currentName;
                            select.appendChild(opt);
                        }
                        select.value = savedData.current;
                        Utils.changeSpotifySource(id);
                    }
                }

                // LOAD YOUTUBE STATE
                if (type === 'youtube' && savedData && savedData.url) {
                    const frame = document.getElementById(`yt-frame-${id}`);
                    const setup = document.getElementById(`yt-setup-${id}`);
                    const controls = document.getElementById(`yt-controls-${id}`);
                    frame.src = savedData.url;
                    frame.style.display = 'block';
                    controls.style.display = 'block';
                    setup.style.display = 'none';
                }
                // LOAD SPOTIFY EMBED STATE
                if (type === 'spotify' && savedData && savedData.url) {
                    const frame = document.getElementById(`sp-frame-${id}`);
                    const setup = document.getElementById(`sp-setup-${id}`);
                    const controls = document.getElementById(`sp-controls-${id}`);
                    frame.src = savedData.url;
                    frame.style.display = 'block';
                    controls.style.display = 'block';
                    setup.style.display = 'none';
                }

                UI.toggleAdd(false);
            };

            const saveLayout = debounce(() => {
                if(!isDashboardLoaded) return; // THE LOCK

                const items = grid.getGridItems().map(el => {
                    const type = el.getAttribute('data-type');
                    let data = null;
                    if (type === 'notes') data = el.querySelector('textarea').value;
                    if (type === 'todo') data = Array.from(el.querySelectorAll('.task-item')).map(i => ({t: i.querySelector('.task-text').innerText, d: i.classList.contains('done')}));
                    if (type === 'links') { data = []; el.querySelectorAll('.deck-btn').forEach(btn => data.push(JSON.parse(btn.getAttribute('data-link') || 'null'))); }
                    if (type === 'countdown') { data = JSON.parse(el.querySelector('.count-container').getAttribute('data-target') || 'null'); }
                    if (type === 'clipboard') { data = Array.from(el.querySelectorAll('.clip-item')).map(i => i.innerText); }
                    if (type === 'timer') { const wrap = el.querySelector('.timer-container'); data = { end: wrap.getAttribute('data-end'), label: el.querySelector('.timer-label').innerText }; }
                    
                    if (type === 'music') { 
                        const select = el.querySelector('select');
                        const name = select.options[select.selectedIndex] ? select.options[select.selectedIndex].innerText : '';
                        data = { current: select.value, currentName: name }; 
                    }
                    
                    if (type === 'weather') { const unit = el.getAttribute('data-unit') || 'F'; data = { unit }; }
                    
                    if (type === 'youtube') {
                        const frame = el.querySelector('iframe');
                        if(frame && frame.src && frame.style.display !== 'none') {
                            data = { url: frame.src };
                        }
                    }

                    if (type === 'spotify') {
                        const frame = el.querySelector('iframe');
                        if(frame && frame.src && frame.style.display !== 'none') {
                            data = { url: frame.src };
                        }
                    }

                    return { x: el.gridstackNode.x, y: el.gridstackNode.y, w: el.gridstackNode.w, h: el.gridstackNode.h, type, data };
                });
                
                Cloud.save(items);
            }, 1000);

            const loadData = () => {
                if(!Cloud.user || !db) return;

                isDashboardLoaded = false; // LOCK
                grid.off('change added removed');

                db.collection('users').doc(Cloud.user.uid).get().then(doc => {
                    grid.removeAll(); 
                    if(doc.exists) {
                        const dbData = doc.data();
                        
                        // CHECK PRO STATUS
                        isPro = dbData.isPro || false;
                        if(isPro) {
                            document.getElementById('upgrade-btn').style.display = 'none';
                            document.getElementById('user-info').innerHTML += '<span class="pro-badge">PRO ⚡</span>';
                        } else {
                            document.getElementById('upgrade-btn').style.display = 'block';
                        }

                        try {
                            const items = JSON.parse(dbData.layout);
                            if(items && items.length > 0) {
                                grid.batchUpdate();
                                items.forEach(s => createWidget(s.type, s.w, s.h, s.x, s.y, s.data));
                                grid.commit();
                            } else {
                                loadDefaults();
                            }
                        } catch(e) { loadDefaults(); }
                    } else {
                        loadDefaults();
                    }
                    
                    // UNLOCK after delay
                    setTimeout(() => {
                        isDashboardLoaded = true;
                        grid.on('change added removed', saveLayout);
                    }, 1000);
                }).catch(e => {
                    console.error("Load failed", e);
                    document.getElementById('error-toast').innerText = "Load Failed: " + e.message;
                    document.getElementById('error-toast').style.display = 'block';
                });
            };

            const loadDefaults = () => {
                grid.batchUpdate();
                createWidget('clock', 4, 2, 0, 0);
                createWidget('weather', 4, 2, 4, 0);
                grid.commit();
                
                setTimeout(() => {
                    isDashboardLoaded = true;
                    saveLayout(); // Force save to fix the DB
                    grid.on('change added removed', saveLayout);
                }, 1000);
            };

            const reset = () => {
                if(confirm("This will clear your dashboard. Are you sure?")) {
                    isDashboardLoaded = false;
                    db.collection('users').doc(Cloud.user.uid).delete().then(() => location.reload());
                }
            };

            return { init, toggleEdit, createWidget, saveLayout, reset, loadData };
        })();

        const UI = {
            toggleAdd: (show) => { const m=document.getElementById('add-modal'), o=document.getElementById('modal-overlay'); if(show){m.classList.add('show');o.classList.add('show');}else{m.classList.remove('show');o.classList.remove('show');}},
            updateTime: () => { const n=new Date(); document.querySelectorAll('.time-big').forEach(e=>e.innerText=n.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true})); document.querySelectorAll('.date-sub').forEach(e=>e.innerText=n.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'}));},
            initTodo: (id, data) => {
                const list = document.getElementById(`list-${id}`), em = document.getElementById(`empty-${id}`);
                if (!list || !em) return;
                const check = () => { em.style.display = list.children.length===0 ? 'block':'none'; };
                const add = (t, d) => {
                    const i = document.createElement('div'); i.className=`task-item ${d?'done':''}`;
                    i.innerHTML=`<div class="task-check"><i class="fa-solid fa-check"></i></div><span class="task-text">${t}</span><i class="fa-solid fa-xmark task-delete" onclick="event.stopPropagation(); this.parentElement.remove(); UI.checkEmpty('${id}'); Core.saveLayout()"></i>`;
                    i.onclick = (e) => {
                        if(e.target.classList.contains('task-delete')) return;
                        i.classList.add('done'); setTimeout(()=>{ i.remove(); check(); Core.saveLayout(); },800);
                    };
                    list.prepend(i); check();
                };
                const input = document.getElementById(`in-${id}`);
                if(input) input.onkeypress = (e) => { if(e.key==='Enter'&&e.target.value.trim()){ add(e.target.value,false); e.target.value=''; Core.saveLayout(); } };
                if(data) data.forEach(d => { if(!d.d) add(d.t, false); }); check();
                UI.checkEmpty = check;
            },
            showToast: (msg) => {
                const el = document.getElementById('action-toast');
                el.innerText = msg;
                el.style.display = 'block';
                el.style.animation = 'none';
                el.offsetHeight; /* trigger reflow */
                el.style.animation = 'popUpFade 2s ease forwards';
                setTimeout(() => { el.style.display = 'none'; }, 2000);
            }
        };

        const Templates = {
            get: (type, id, data) => {
                const validTypes = ['clock', 'links', 'countdown', 'calc', 'weather', 'todo', 'notes', 'calendar', 'music', 'timer', 'battery', 'password', 'clipboard', 'youtube', 'spotify'];
                if(!validTypes.includes(type)) return `<div>Error</div>`;

                const wrap = (l, c) => `<div class="remove-widget">✕</div><div class="w-header" data-type="${type}"><span class="w-label">${l}</span></div><div class="w-content" data-type="${type}">${c}</div>`;
                const getLink = (idx, s) => { const h = s&&s.url; const icon = h ? `<img src="https://www.google.com/s2/favicons?domain=${s.domain}&sz=64" class="deck-favicon"><span class="deck-label">${s.name}</span>` : `<i class="fa-solid fa-plus deck-icon deck-unset"></i>`; return `<div class="deck-btn" onclick="Utils.linkAction('${id}', ${idx}, this)" oncontextmenu="event.preventDefault(); Utils.editLink('${id}', ${idx}, this)" data-link='${h?JSON.stringify(s):""}'>${icon}</div>`; };

                const map = {
                    clock: `<div class="remove-widget">✕</div><div class="clock-container"><div class="time-big">00:00</div><div class="date-sub">Loading...</div></div>`,
                    links: wrap('Quick Links', `<div class="deck-grid">${getLink(0,data?.[0])}${getLink(1,data?.[1])}${getLink(2,data?.[2])}</div>`),
                    countdown: `<div class="remove-widget">✕</div><div class="count-container" id="count-wrap-${id}" onclick="Utils.setCountdown('${id}')" data-target='${data?JSON.stringify(data):""}'><div class="count-days" id="cd-val-${id}">${data?'--':'+'}</div><div class="count-label" id="cd-lbl-${id}">${data?'Loading...':'Set Date'}</div><div class="count-progress"><div class="count-fill" id="cd-bar-${id}"></div></div></div>`,
                    calc: wrap('Calculator', `<div id="scr-${id}" class="calc-screen">0</div><div class="calc-grid">${['C','÷','×','7','8','9','4','5','6','1','2','3','0','.','='].map(k=>`<button class="calc-btn ${['C','÷','×','='].includes(k)?'calc-orange':''}" onclick="Utils.calc('${id}','${k}')">${k}</button>`).join('')}</div>`),
                    weather: wrap('Weather', `<div style="display:flex;align-items:center;justify-content:center;gap:15px;height:100%"><i class="fa-solid fa-cloud-sun" style="font-size:32px;color:var(--text-main)"></i><div><div id="temp-${id}" class="weather-temp" style="font-size:28px;font-weight:400">--°</div><div style="font-size:11px;color:var(--text-sec)">Mostly Clear</div></div></div>`),
                    todo: wrap('Reminders', `<div class="task-input-row"><input id="in-${id}" class="task-input" placeholder="Add task..."></div><div id="list-${id}" class="task-list"></div><div id="empty-${id}" class="task-empty">No tasks</div>`),
                    notes: wrap('Notes', `<textarea id="nt-${id}" style="flex:1;resize:none;background:transparent;border:none;padding:0;font-family:inherit;font-size:14px;line-height:1.4" placeholder="Type here..." oninput="Core.saveLayout()"></textarea>`),
                    calendar: `<div class="remove-widget">✕</div><div class="cal-wrapper"><div class="cal-header"><i class="fa-solid fa-chevron-left cal-nav" onclick="Utils.changeMonth('${id}', -1)"></i><span id="cal-title-${id}" class="cal-title" onclick="Utils.resetCalendar('${id}')">Month Year</span><i class="fa-solid fa-chevron-right cal-nav" onclick="Utils.changeMonth('${id}', 1)"></i></div><div class="cal-weekdays"><span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span></div><div id="cal-grid-${id}" class="cal-grid"></div></div>`,
                    
                    // MODIFIED MUSIC WIDGET FOR SPOTIFY API
                    music: wrap('Music', `<div class="music-header" style="display:flex;gap:5px;margin-bottom:10px;align-items:center"><select id="ms-sel-${id}" style="flex:1;background:var(--ios-input);color:white;border-radius:8px;border:none;outline:none;font-size:12px;padding:6px" onchange="Utils.changeSpotifySource('${id}')"><option value="">Select Playlist...</option></select><button class="btn" style="background:#1DB954; color:white; font-size:12px; padding:4px 8px; border-radius:6px" onclick="Utils.loginSpotify('${id}')"><i class="fa-brands fa-spotify"></i> Connect</button></div><div style="flex:1;border-radius:12px;overflow:hidden;background:black;position:relative"><div id="ms-setup-${id}" style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;text-align:center;gap:10px"><i class="fa-brands fa-spotify" style="font-size:40px;color:#1DB954"></i><p style="font-size:12px;color:var(--text-sec)">Connect to view playlists</p></div><iframe id="ms-frame-${id}" style="width:100%;height:100%;border:none;display:none" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe></div>`),
                    
                    timer: wrap('Event Timer', `<div class="timer-container" id="timer-wrap-${id}" onclick="Utils.setTimer('${id}')"><div id="timer-val-${id}" class="timer-big">--:--</div><div id="timer-lbl-${id}" class="timer-label">Click to Set</div><div class="timer-bar"><div id="timer-bar-${id}" class="timer-fill"></div></div></div>`),
                    battery: wrap('Battery', `<div class="batt-container"><div class="batt-icon-shell"><div class="batt-fill" id="batt-fill-${id}"></div></div><div><div id="batt-val-${id}" class="batt-text">--%</div><div id="batt-st-${id}" class="batt-state">Reading...</div></div></div>`),
                    password: wrap('Passwords', `<div id="pass-${id}" class="pass-display" onclick="Utils.copyPass('${id}')">CLICK GEN</div><div class="pass-controls"><span id="lbl-${id}" style="font-size:11px;color:var(--text-sec);width:60px">Length: 16</span><input type="range" id="rng-${id}" min="8" max="32" value="16" style="flex:1" oninput="Utils.genPass('${id}')"><button class="btn" onclick="Utils.genPass('${id}')">Gen</button></div>`),
                    clipboard: wrap('Clipboard', `<button class="btn btn-primary" style="width:100%; justify-content:center" onclick="Utils.saveClip('${id}')"><i class="fa-solid fa-paste"></i> Save Recent</button><div id="clip-${id}" class="clip-list"></div>`),
                    
                    youtube: `<div class="remove-widget">✕</div><div class="yt-container"><div id="yt-setup-${id}" class="yt-setup"><i class="fa-brands fa-youtube" style="font-size:40px;color:#FF0000;margin-bottom:10px"></i><input id="yt-input-${id}" class="yt-input" placeholder="Paste YouTube Link..." onkeypress="if(event.key==='Enter') Utils.loadYT('${id}')"><button class="btn" onclick="Utils.loadYT('${id}')">Load</button></div><iframe id="yt-frame-${id}" class="yt-frame" style="display:none" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe><div id="yt-controls-${id}" class="yt-controls" style="display:none"><button class="btn btn-danger" onclick="Utils.resetYT('${id}')"><i class="fa-solid fa-xmark"></i></button></div></div>`,
                    
                    spotify: `<div class="remove-widget">✕</div><div class="sp-container"><div id="sp-setup-${id}" class="sp-setup"><i class="fa-brands fa-spotify" style="font-size:40px;color:#1DB954;margin-bottom:10px"></i><div style="font-size:12px;color:var(--text-sec)">Paste Spotify Song/Playlist Link</div><input id="sp-input-${id}" class="yt-input" placeholder="https://open.spotify.com/playlist/..." onkeypress="if(event.key==='Enter') Utils.loadSpotify('${id}')"><button class="btn" onclick="Utils.loadSpotify('${id}')">Load</button></div><iframe id="sp-frame-${id}" class="sp-frame" style="display:none" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe><div id="sp-controls-${id}" class="yt-controls" style="display:none"><button class="btn btn-danger" onclick="Utils.resetSpotify('${id}')"><i class="fa-solid fa-xmark"></i></button></div></div>`
                };
                return map[type] || `<div>Error</div>`;
            }
        };

        window.onload = Core.init;
    </script>
</body>
</html>
